<th:block th:replace="~{participant/fragments/header}"></th:block>
<!DOCTYPE html>
<html lang="az" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>İmtahan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Cavabların rəngi */
        .text-correct { color: green !important; }
        .text-wrong { color: red !important; }

        /* Summernote və p tag inline */
        .answer-list li p {
            display: inline;
            margin: 0;
        }

        /* Cavablar listi */
        .answer-list li {
            list-style: none;
            padding: 5px 10px;
            margin-bottom: 3px;
            border-radius: 5px;
        }

        /* Button sağ tərəfə */
        .btn-right {
            float: right;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="card">
        <div class="card-body">
            <!-- Sual başlığı -->
            <h4 class="mb-4" th:text="'Sual ' + (${questionIndex} + 1) + ' / ' + ${totalQuestions}"></h4>

            <!-- Sual mətni -->
            <p class="lead" th:utext="${question.question}"></p>

            <!-- Cavab formu -->
            <form id="answerForm"
                  th:data-topic-id="${topicId}"
                  th:data-question-id="${question.id}"
                  th:data-question-index="${questionIndex}"
                  th:data-total-questions="${totalQuestions}">

                <!-- Cavab variantları -->
                <div class="form-check mb-2" th:each="answer : ${question.answers}">
                    <input class="form-check-input" type="radio" name="answerId"
                           th:value="${answer.id}" th:id="'answer_' + ${answer.id}" required>
                    <label class="form-check-label" th:for="'answer_' + ${answer.id}"
                           th:utext="${answer.answer}"></label>
                </div>

                <!-- Növbəti sual / Nəticə düyməsi -->
                <button type="submit" class="btn btn-primary mt-3 btn-right"
                        th:text="${questionIndex + 1 == totalQuestions} ? 'Nəticə' : 'Növbəti'">
                    Növbəti
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // LocalStorage-da cavabları toplamaq üçün array
    let collectedAnswers = JSON.parse(localStorage.getItem('collectedAnswers')) || [];

    document.getElementById("answerForm").addEventListener("submit", function (e) {
        e.preventDefault(); // Formun default submit-in blokla
        const form = e.target;
        const topicId = form.dataset.topicId;
        const questionId = parseInt(form.dataset.questionId);
        const questionIndex = parseInt(form.dataset.questionIndex);
        const totalQuestions = parseInt(form.dataset.totalQuestions);

        const selected = form.querySelector('input[name="answerId"]:checked');
        if (!selected) return;

        const selectedId = selected.value;

        // Cavabı toplamaq
        collectedAnswers.push({
            questionId: questionId,
            answerId: parseInt(selectedId)
        });
        localStorage.setItem('collectedAnswers', JSON.stringify(collectedAnswers));

        if (questionIndex + 1 === totalQuestions) {
            // Sonuncu sual → nəticəni POST et
            const payload = {
                topicId: parseInt(topicId),
                answers: collectedAnswers
            };

            fetch(`/quiz/${topicId}/result`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(response => {
                if (response.ok) {
                    localStorage.removeItem('collectedAnswers');
                    collectedAnswers = [];
                    return response.text().then(html => {
                        document.open();
                        document.write(html);
                        document.close();
                    });
                } else {
                    console.error("Error submitting results");
                }
            });
        } else {
            // Növbəti sual → GET redirect
            window.location.href = `/quiz/${topicId}/question/${questionIndex + 1}`;
        }
    });
</script>

<th:block th:replace="~{participant/fragments/footer}"></th:block>
